# Promptfoo configuration for Layout Generation Tests
# Tests that generated layouts are valid, appropriate, and follow guidelines

description: 'Portfolio AI - Layout Generation Tests'

# Provider configuration - uses Wrangler Worker Layout provider (integration test)
providers:
  - id: 'layout-worker'

# Note: Prompts are now embedded in the worker, not used directly
prompts:
  - 'Layout generation via worker'

# Default variables for all tests
defaultTest:
  vars:
    portfolioContent: {} # Minimal portfolio content

tests:
  # ==========================================
  # LAYOUT GENERATION TESTS
  # ==========================================

  # Test: Recruiter layout generation
  - description: 'Generate valid layout for recruiter'
    vars:
      visitorTag: RECRUITER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return ['single-column', 'two-column', 'hero-focused'].includes(result.layout);
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return ['blue', 'green', 'purple', 'orange', 'pink'].includes(result.theme?.accent);
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return Array.isArray(result.sections) && result.sections.length >= 3 && result.sections.length <= 5;
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const validComponents = ['Hero', 'CardGrid', 'SkillBadges', 'Timeline', 'ContactForm', 'TextBlock', 'ImageGallery', 'StatsCounter', 'TechLogos', 'DataChart'];
          return result.sections.every(s => validComponents.includes(s.type));

  - description: 'Recruiter layout includes Hero and professional sections'
    vars:
      visitorTag: RECRUITER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const hasHero = result.sections.some(s => s.type === 'Hero');
          const hasProfessional = result.sections.some(s =>
            s.type === 'Timeline' || s.type === 'SkillBadges' || s.type === 'CardGrid'
          );
          return hasHero && hasProfessional;

  # Test: Developer layout generation
  - description: 'Generate valid layout for developer'
    vars:
      visitorTag: DEVELOPER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return ['single-column', 'two-column', 'hero-focused'].includes(result.layout);
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return Array.isArray(result.sections) && result.sections.length >= 3;

  - description: 'Developer layout emphasizes projects and skills'
    vars:
      visitorTag: DEVELOPER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const hasProjects = result.sections.some(s => s.type === 'CardGrid');
          const hasSkills = result.sections.some(s => s.type === 'SkillBadges');
          return hasProjects && hasSkills;

  # Test: Collaborator layout generation
  - description: 'Generate valid layout for collaborator'
    vars:
      visitorTag: COLLABORATOR
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return ['single-column', 'two-column', 'hero-focused'].includes(result.layout);
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return Array.isArray(result.sections);

  - description: 'Collaborator layout includes contact and projects'
    vars:
      visitorTag: COLLABORATOR
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const hasContact = result.sections.some(s => s.type === 'ContactForm');
          const hasProjects = result.sections.some(s => s.type === 'CardGrid');
          return hasContact || hasProjects;

  # Test: Friend layout generation
  - description: 'Generate valid layout for friend'
    vars:
      visitorTag: FRIEND
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return ['single-column', 'two-column', 'hero-focused'].includes(result.layout);

  - description: 'Friend layout is more personal/casual'
    vars:
      visitorTag: FRIEND
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const hasPersonal = result.sections.some(s =>
            s.type === 'Hero' || s.type === 'TextBlock' || s.type === 'ImageGallery'
          );
          return hasPersonal;

  # Test: Layout uses valid project IDs
  - description: 'Layout only uses valid project IDs'
    vars:
      visitorTag: DEVELOPER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const validProjectIds = ['kiwi', 'ask', 'vtuber-chat', 'spiegel-2d'];
          const cardGrids = result.sections.filter(s => s.type === 'CardGrid');
          if (cardGrids.length === 0) return true;
          return cardGrids.every(cg => {
            if (!cg.props?.items) return true;
            return cg.props.items.every(id => validProjectIds.includes(id));
          });

  # Test: Layout uses valid experience IDs
  - description: 'Layout only uses valid experience IDs in Timeline'
    vars:
      visitorTag: RECRUITER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const validExperienceIds = ['nyu-shanghai'];
          const timelines = result.sections.filter(s => s.type === 'Timeline');
          if (timelines.length === 0) return true;
          return timelines.every(tl => {
            if (!tl.props?.items) return true;
            return tl.props.items.every(id => validExperienceIds.includes(id));
          });

  # Test: CardGrid has valid columns value
  - description: 'CardGrid uses valid column values (2, 3, or 4)'
    vars:
      visitorTag: DEVELOPER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const cardGrids = result.sections.filter(s => s.type === 'CardGrid');
          if (cardGrids.length === 0) return true;
          return cardGrids.every(cg => {
            if (!cg.props?.columns) return true;
            return [2, 3, 4].includes(cg.props.columns);
          });

  # Test: SkillBadges has valid style
  - description: 'SkillBadges uses valid style (compact or detailed)'
    vars:
      visitorTag: DEVELOPER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const skillBadges = result.sections.filter(s => s.type === 'SkillBadges');
          if (skillBadges.length === 0) return true;
          return skillBadges.every(sb => {
            if (!sb.props?.style) return true;
            return ['compact', 'detailed'].includes(sb.props.style);
          });

  # Test: Custom intent affects layout
  - description: 'Custom intent influences layout content'
    vars:
      visitorTag: DEVELOPER
      customIntent: "I'm specifically interested in your AI and RAG projects"
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const hasCardGrid = result.sections.some(s => s.type === 'CardGrid');
          return hasCardGrid;

  # Test: Consistency across multiple runs
  - description: 'Layout structure is consistent for recruiter (run 1)'
    vars:
      visitorTag: RECRUITER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return !!(result.layout && result.theme && result.sections);

  - description: 'Layout structure is consistent for recruiter (run 2)'
    vars:
      visitorTag: RECRUITER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return !!(result.layout && result.theme && result.sections);

  # ==========================================
  # DataChart COMPONENT TESTS
  # ==========================================

  - description: 'DataChart uses valid chart types'
    vars:
      visitorTag: DEVELOPER
      customIntent: 'Show me github activity charts'
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const validTypes = ['area', 'bar', 'line', 'pie', 'radar', 'radial'];
          const dataCharts = result.sections.filter(s => s.type === 'DataChart');
          if (dataCharts.length === 0) return true;
          return dataCharts.every(dc =>
            dc.props?.charts?.every(c => validTypes.includes(c.type))
          );

  - description: 'DataChart uses valid data sources'
    vars:
      visitorTag: DEVELOPER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const validSources = ['github', 'weather'];
          const dataCharts = result.sections.filter(s => s.type === 'DataChart');
          if (dataCharts.length === 0) return true;
          return dataCharts.every(dc =>
            dc.props?.charts?.every(c => validSources.includes(c.source))
          );

  - description: 'DataChart uses valid aggregation options'
    vars:
      visitorTag: DEVELOPER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const validAggregations = ['hourly', 'daily', 'weekly', 'monthly', 'byDayOfWeek'];
          const dataCharts = result.sections.filter(s => s.type === 'DataChart');
          if (dataCharts.length === 0) return true;
          return dataCharts.every(dc =>
            dc.props?.charts?.every(c =>
              !c.aggregation || validAggregations.includes(c.aggregation)
            )
          );

  - description: 'Weather DataChart has valid metrics'
    vars:
      visitorTag: FRIEND
      customIntent: 'Show local weather'
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const validMetrics = ['temperature', 'humidity', 'precipitation', 'wind'];
          const dataCharts = result.sections.filter(s => s.type === 'DataChart');
          if (dataCharts.length === 0) return true;
          return dataCharts.every(dc =>
            dc.props?.charts?.every(c =>
              c.source !== 'weather' || !c.weatherMetric || validMetrics.includes(c.weatherMetric)
            )
          );

  # ==========================================
  # StatsCounter COMPONENT TESTS
  # ==========================================

  - description: 'StatsCounter has valid stats structure'
    vars:
      visitorTag: RECRUITER
      customIntent: 'Show key metrics'
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const statsCounters = result.sections.filter(s => s.type === 'StatsCounter');
          if (statsCounters.length === 0) return true;
          return statsCounters.every(sc =>
            Array.isArray(sc.props?.stats) &&
            sc.props.stats.every(s => typeof s.label === 'string' && typeof s.value === 'number')
          );

  # ==========================================
  # TechLogos COMPONENT TESTS
  # ==========================================

  - description: 'TechLogos has valid style option'
    vars:
      visitorTag: DEVELOPER
      customIntent: 'Show tech stack'
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const validStyles = ['grid', 'marquee'];
          const techLogos = result.sections.filter(s => s.type === 'TechLogos');
          if (techLogos.length === 0) return true;
          return techLogos.every(tl =>
            !tl.props?.style || validStyles.includes(tl.props.style)
          );

  - description: 'TechLogos has valid size option'
    vars:
      visitorTag: DEVELOPER
      customIntent: ''
    assert:
      - type: is-json
      - type: javascript
        value: |
          const result = JSON.parse(output);
          const validSizes = ['sm', 'md', 'lg'];
          const techLogos = result.sections.filter(s => s.type === 'TechLogos');
          if (techLogos.length === 0) return true;
          return techLogos.every(tl =>
            !tl.props?.size || validSizes.includes(tl.props.size)
          );

# Output configuration
outputPath: promptfoo/output/layout

# Evaluation settings
evaluateOptions:
  maxConcurrency: 2
  showProgressBar: true
